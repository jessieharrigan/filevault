name: Deploy FileVault Application

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

env:
  ACR_NAME: filevaultjessie
  IMAGE_NAME: filevault-app
  IMAGE_TAG: v1.0.1

jobs:
  deploy:
    runs-on: ubuntu-latest # Using GitHub-hosted runner

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: ðŸ³ Docker Login to ACR
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: ðŸ—ï¸ Build Docker Image
        run: |
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            -f src/azure-sa/Dockerfile \
            .

      - name: ðŸš€ Push Image to ACR
        run: |
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false # Required to capture outputs easily

      - name: ðŸ—ï¸ Terraform Init & Apply
        working-directory: ./terraform
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          terraform init
          terraform plan -out=tfplan
          ls -lh tfplan
          terraform apply -auto-approve tfplan
          
          echo "STORAGE_ACCOUNT_NAME=$(terraform output -raw storage_account_name)" >> $GITHUB_ENV
          echo "STORAGE_ACCOUNT_KEY=$(terraform output -raw storage_account_key)" >> $GITHUB_ENV
          echo "CONTAINER_NAME=$(terraform output -raw container_name)" >> $GITHUB_ENV

      - name: âœ… Verify Azure Deployment
        run: |
          az container show \
            --resource-group rg-filevault \
            --name filevault-app-jessie \
            --query "{FQDN:ipAddress.fqdn, ProvisioningState:provisioningState}" \
            -o table

      - name: ðŸ§¹ Cleanup
        if: always()
        run: docker system prune -f || true