name: Deploy FileVault Application

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

env:
  DOCKER_IMAGE: filevault

jobs:
  deploy:
    runs-on: ubuntu-latest # Using GitHub-hosted runner

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: üîß Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false # Required to capture outputs easily

      - name: üèóÔ∏è Terraform Init & Apply
        working-directory: ./terraform
        run: |
          terraform init
          terraform apply -auto-approve -out=tfplan
          
          # Capture outputs into GHA environment variables
          echo "STORAGE_ACCOUNT_NAME=$(terraform output -raw storage_account_name)" >> $GITHUB_ENV
          echo "STORAGE_ACCOUNT_KEY=$(terraform output -raw storage_account_key)" >> $GITHUB_ENV
          echo "CONTAINER_NAME=$(terraform output -raw container_name)" >> $GITHUB_ENV

      - name: üê≥ Build Docker Image
        working-directory: ./src/azure-sa
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ github.run_number }} .
          docker tag ${{ env.DOCKER_IMAGE }}:${{ github.run_number }} ${{ env.DOCKER_IMAGE }}:latest

      - name: ‚ñ∂Ô∏è Run Application
        run: |
          # Stop old if exists (ignore error if not found)
          docker stop filevault || true
          docker rm filevault || true
          
          docker run -d \
            --name filevault \
            -p 3000:3000 \
            -e AZURE_STORAGE_ACCOUNT_NAME=${{ env.STORAGE_ACCOUNT_NAME }} \
            -e AZURE_STORAGE_ACCOUNT_KEY=${{ env.STORAGE_ACCOUNT_KEY }} \
            -e AZURE_CONTAINER_NAME=${{ env.CONTAINER_NAME }} \
            -e PORT=3000 \
            ${{ env.DOCKER_IMAGE }}:latest

      - name: ‚úÖ Verify Application
        run: |
          sleep 5
          docker ps | grep filevault
          docker logs filevault --tail 20
          echo "üéâ Application is accessible at http://localhost:3000"

      - name: üßπ Cleanup
        if: always() # Equivalent to Jenkins 'post { always }'
        run: docker system prune -f || true